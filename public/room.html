<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ MaÃ§ OdasÄ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="room-page">
    <div class="room-container">
        <!-- Sol: Video OynatÄ±cÄ± -->
        <div class="video-section">
            <div class="video-header">
                <div class="room-info">
                    <span class="room-code">ğŸ”‘ Oda: <strong id="roomCode"></strong></span>
                    <button class="btn-small" id="copyCode">ğŸ“‹ Kopyala</button>
                </div>
                <div class="user-count">
                    <span id="userCount">0</span>/7 ğŸ‘¥
                </div>
            </div>

            <div class="video-wrapper">
                <video id="videoPlayer" controls playsinline>
                    TarayÄ±cÄ±nÄ±z video oynatmayÄ± desteklemiyor.
                </video>
                <div class="reactions-container" id="reactions"></div>
                <div class="video-overlay" id="videoOverlay">
                    <div class="overlay-content">
                        <p>ğŸ“º Video URL'si girin</p>
                    </div>
                </div>
            </div>

            <div class="video-controls" id="videoControls" style="display: none;">
                <input type="text" id="videoUrl" placeholder="M3U8/HLS video linki yapÄ±ÅŸtÄ±r..." class="video-input">
                <button class="btn btn-primary" id="loadVideo">â–¶ï¸ YÃ¼kle</button>
            </div>

            <!-- Emoji Tepkileri -->
            <div class="emoji-bar">
                <button class="emoji-btn" data-emoji="âš½">âš½</button>
                <button class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button>
                <button class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
                <button class="emoji-btn" data-emoji="ğŸ˜±">ğŸ˜±</button>
                <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
                <button class="emoji-btn" data-emoji="ğŸ˜­">ğŸ˜­</button>
                <button class="emoji-btn" data-emoji="ğŸ¤¬">ğŸ¤¬</button>
                <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
            </div>
        </div>

        <!-- SaÄŸ: Chat ve KullanÄ±cÄ±lar -->
        <div class="chat-section">
            <div class="users-panel">
                <h3>ğŸ‘¥ Odadakiler</h3>
                <ul id="userList"></ul>
            </div>

            <div class="chat-panel">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Mesaj yaz..." maxlength="200">
                    <button class="btn-send" id="sendMessage">ğŸ“¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomId = window.location.pathname.split('/').pop();
        const username = localStorage.getItem('username') || 'Misafir' + Math.floor(Math.random() * 1000);
        const socket = io();

        const video = document.getElementById('videoPlayer');
        const videoOverlay = document.getElementById('videoOverlay');
        let hls = null;
        let isSyncing = false;
        let isHost = false;

        // Oda kodunu gÃ¶ster
        document.getElementById('roomCode').textContent = roomId;

        // Kopyala butonu
        document.getElementById('copyCode').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href);
            alert('Link kopyalandÄ±! ArkadaÅŸlarÄ±na gÃ¶nder ğŸ‰');
        });

        // Odaya katÄ±l
        socket.emit('join-room', { roomId, username });

        // Oda dolu
        socket.on('room-full', () => {
            alert('Oda dolu! Maksimum 7 kiÅŸi.');
            window.location.href = '/';
        });

        // KullanÄ±cÄ± katÄ±ldÄ±
        socket.on('user-joined', (data) => {
            // Ev sahibi kontrolÃ¼
            const currentUser = data.users.find(u => u.username === username);
            isHost = currentUser ? currentUser.isHost : false;
            
            // Video yÃ¼kleme bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster/gizle
            const videoControls = document.querySelector('.video-controls');
            if (isHost) {
                videoControls.style.display = 'flex';
            } else {
                videoControls.style.display = 'none';
            }
            
            updateUserList(data.users);
            if (data.videoUrl) {
                document.getElementById('videoUrl').value = data.videoUrl;
                loadHLSVideo(data.videoUrl);
                
                // Senkronize ol
                setTimeout(() => {
                    video.currentTime = data.currentTime;
                    if (data.isPlaying) {
                        video.play().catch(() => {});
                    }
                }, 1000);
            }
            addSystemMessage(`${data.user.username} odaya katÄ±ldÄ±! ğŸ‰`);
        });

        // KullanÄ±cÄ± ayrÄ±ldÄ±
        socket.on('user-left', (data) => {
            updateUserList(data.users);
            addSystemMessage(`${data.username} ayrÄ±ldÄ± ğŸ‘‹`);
        });

        // Video deÄŸiÅŸti
        socket.on('video-changed', (data) => {
            document.getElementById('videoUrl').value = data.videoUrl;
            loadHLSVideo(data.videoUrl);
        });

        // Video senkronizasyonu
        socket.on('sync-video', (data) => {
            isSyncing = true;
            
            const timeDiff = Math.abs(video.currentTime - data.currentTime);
            if (timeDiff > 2) {
                video.currentTime = data.currentTime;
            }

            if (data.isPlaying && video.paused) {
                video.play().catch(() => {});
            } else if (!data.isPlaying && !video.paused) {
                video.pause();
            }

            setTimeout(() => { isSyncing = false; }, 500);
        });

        // Chat geÃ§miÅŸi
        socket.on('chat-history', (messages) => {
            messages.forEach(msg => addChatMessage(msg));
        });

        // Yeni mesaj
        socket.on('new-message', (msg) => {
            addChatMessage(msg);
        });

        // Emoji tepkisi
        socket.on('show-reaction', (data) => {
            showReaction(data.emoji);
        });

        // Video yÃ¼kle
        document.getElementById('loadVideo').addEventListener('click', () => {
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) {
                alert('Video URL girin!');
                return;
            }
            socket.emit('set-video', { roomId, videoUrl: url });
            loadHLSVideo(url);
        });

        // HLS Video yÃ¼kle
        function loadHLSVideo(url) {
            videoOverlay.style.display = 'none';

            if (hls) {
                hls.destroy();
            }

            if (url.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log('HLS yÃ¼klendi');
                    });
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS HatasÄ±:', data);
                        if (data.fatal) {
                            alert('Video yÃ¼klenemedi! URL\'yi kontrol edin.');
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                }
            } else {
                video.src = url;
            }
        }

        // Video olaylarÄ±
        video.addEventListener('play', () => {
            if (!isSyncing) {
                socket.emit('play-pause', { 
                    roomId, 
                    isPlaying: true, 
                    currentTime: video.currentTime 
                });
            }
        });

        video.addEventListener('pause', () => {
            if (!isSyncing) {
                socket.emit('play-pause', { 
                    roomId, 
                    isPlaying: false, 
                    currentTime: video.currentTime 
                });
            }
        });

        video.addEventListener('seeked', () => {
            if (!isSyncing) {
                socket.emit('seek', { roomId, currentTime: video.currentTime });
            }
        });

        // KullanÄ±cÄ± listesi gÃ¼ncelle
        function updateUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = users.map(u => `
                <li class="${u.username === username ? 'me' : ''}">
                    ${u.isHost ? 'ğŸ‘‘' : (u.username === username ? 'ğŸ‘¤' : 'ğŸ‘¥')} ${u.username}
                    ${u.isHost ? '<span style="color: #00ff87; font-size: 10px;">(Ev Sahibi)</span>' : ''}
                </li>
            `).join('');
            document.getElementById('userCount').textContent = users.length;
        }

        // Chat mesajÄ± ekle
        function addChatMessage(msg) {
            const container = document.getElementById('chatMessages');
            const isMe = msg.username === username;
            const div = document.createElement('div');
            div.className = `chat-message ${isMe ? 'me' : ''}`;
            div.innerHTML = `
                <span class="chat-user">${msg.username}</span>
                <span class="chat-text">${escapeHtml(msg.message)}</span>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Sistem mesajÄ±
        function addSystemMessage(text) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'chat-message system';
            div.innerHTML = `<span class="chat-text">${text}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Emoji tepkisi gÃ¶ster
        function showReaction(emoji) {
            const container = document.getElementById('reactions');
            const span = document.createElement('span');
            span.className = 'floating-emoji';
            span.textContent = emoji;
            span.style.left = Math.random() * 80 + 10 + '%';
            container.appendChild(span);
            setTimeout(() => span.remove(), 2000);
        }

        // HTML escape
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Mesaj gÃ¶nder
        document.getElementById('sendMessage').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                socket.emit('chat-message', { roomId, message });
                input.value = '';
            }
        }

        // Emoji butonlarÄ±
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                socket.emit('reaction', { roomId, emoji: btn.dataset.emoji });
            });
        });
    </script>
</body>
</html>

