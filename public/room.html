<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ MaÃ§ OdasÄ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body class="room-page">
    <div class="room-container">
        <!-- Sol: Video OynatÄ±cÄ± -->
        <div class="video-section">
            <div class="video-header">
                <div class="room-info">
                    <span class="room-code">ğŸ”‘ Oda: <strong id="roomCode"></strong></span>
                    <button class="btn-small" id="copyCode">ğŸ“‹ Kopyala</button>
                </div>
                <div class="user-count">
                    <span id="userCount">0</span>/7 ğŸ‘¥
                </div>
            </div>

            <div class="video-wrapper">
                <video id="videoPlayer" controls playsinline autoplay muted>
                    TarayÄ±cÄ±nÄ±z video oynatmayÄ± desteklemiyor.
                </video>
                <div id="guestControlOverlay" class="guest-control-overlay" style="display: none;">
                    <div class="guest-message">
                        <p>â¸ï¸ Video kontrolÃ¼ sadece ev sahibine aittir</p>
                        <button id="unmuteBtn" class="btn-unmute">ğŸ”Š Sesi AÃ§</button>
                    </div>
                </div>
                <div class="reactions-container" id="reactions"></div>
                <div class="video-overlay" id="videoOverlay">
                    <div class="overlay-content">
                        <p>ğŸ“º Video URL'si girin</p>
                    </div>
                </div>
            </div>

            <div class="video-controls hidden" id="videoControls">
                <input type="text" id="videoUrl" placeholder="M3U8/HLS video linki yapÄ±ÅŸtÄ±r..." class="video-input">
                <button class="btn btn-primary" id="loadVideo">â–¶ï¸ YÃ¼kle</button>
            </div>

            <!-- Emoji Tepkileri -->
            <div class="emoji-bar">
                <button class="emoji-btn" data-emoji="âš½">âš½</button>
                <button class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button>
                <button class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
                <button class="emoji-btn" data-emoji="ğŸ˜±">ğŸ˜±</button>
                <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
                <button class="emoji-btn" data-emoji="ğŸ˜­">ğŸ˜­</button>
                <button class="emoji-btn" data-emoji="ğŸ¤¬">ğŸ¤¬</button>
                <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
            </div>
        </div>

        <!-- SaÄŸ: Chat ve KullanÄ±cÄ±lar -->
        <div class="chat-section">
            <div class="users-panel">
                <h3>ğŸ‘¥ Odadakiler</h3>
                <ul id="userList"></ul>
                
                <!-- Sesli KonuÅŸma KontrolÃ¼ -->
                <div class="voice-controls">
                    <button class="btn-voice" id="toggleMic">
                        <span class="mic-icon">ğŸ¤</span>
                        <span class="mic-text">Mikrofon AÃ§</span>
                    </button>
                    <div class="voice-status" id="voiceStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">Ses KapalÄ±</span>
                    </div>
                </div>
            </div>

            <div class="chat-panel">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-wrapper" id="chatInputWrapper">
                    <input type="text" id="chatInput" placeholder="Mesaj yaz..." maxlength="200">
                    <button class="btn-send" id="sendMessage">ğŸ“¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomId = window.location.pathname.split('/').pop();
        const username = localStorage.getItem('username') || 'Misafir' + Math.floor(Math.random() * 1000);
        const socket = io();

        const video = document.getElementById('videoPlayer');
        const videoOverlay = document.getElementById('videoOverlay');
        let hls = null;
        let isSyncing = false;
        let isHost = false;
        let lastSyncTime = 0;
        let syncDebounceTimer = null;

        // Sesli konuÅŸma deÄŸiÅŸkenleri
        let peer = null;
        let myStream = null;
        let peers = {};
        let isMicOn = false;

        // Oda kodunu gÃ¶ster
        document.getElementById('roomCode').textContent = roomId;

        // Kopyala butonu
        document.getElementById('copyCode').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href);
            alert('Link kopyalandÄ±! ArkadaÅŸlarÄ±na gÃ¶nder ğŸ‰');
        });

        // Odaya katÄ±l
        socket.emit('join-room', { roomId, username });

        // Chat gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ zorla (mobil iÃ§in)
        const forceChatVisible = () => {
            try {
                const chatMessages = document.getElementById('chatMessages');
                const chatPanel = document.querySelector('.chat-panel');
                const chatInputWrapper = document.getElementById('chatInputWrapper');
                
                if (chatMessages) {
                    chatMessages.style.cssText = `
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        overflow-y: auto !important;
                        padding: 15px !important;
                        padding-bottom: 100px !important;
                        background: #161b22 !important;
                        position: relative !important;
                        z-index: 1 !important;
                        min-height: 200px !important;
                        height: auto !important;
                    `;
                }
                
                if (chatPanel) {
                    chatPanel.style.cssText = `
                        display: flex !important;
                        flex-direction: column !important;
                        overflow: visible !important;
                        height: 100% !important;
                    `;
                }
                
                if (chatInputWrapper && window.innerWidth <= 900) {
                    chatInputWrapper.style.cssText = `
                        display: flex !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        position: fixed !important;
                        bottom: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        width: 100% !important;
                        background: #161b22 !important;
                        z-index: 9999 !important;
                        padding: 15px !important;
                    `;
                }
            } catch (err) {
                console.error('Chat gÃ¶rÃ¼nÃ¼rlÃ¼k hatasÄ±:', err);
            }
        };
        
        // Sayfa yÃ¼klendiÄŸinde zorla
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                forceChatVisible();
                setTimeout(forceChatVisible, 100);
                setTimeout(forceChatVisible, 500);
            });
        } else {
            forceChatVisible();
            setTimeout(forceChatVisible, 100);
            setTimeout(forceChatVisible, 500);
        }
        
        // Mobilde periyodik kontrol
        if (window.innerWidth <= 900) {
            setInterval(forceChatVisible, 2000);
        }

        // Ev sahibi durumu al
        socket.on('your-host-status', (data) => {
            isHost = data.isHost;
            const videoControls = document.getElementById('videoControls');
            const guestOverlay = document.getElementById('guestControlOverlay');
            
            if (videoControls) {
                if (isHost) {
                    videoControls.classList.remove('hidden');
                    videoControls.style.display = 'flex';
                } else {
                    videoControls.classList.add('hidden');
                    videoControls.style.display = 'none';
                }
            }
            
            // Video kontrollerini ev sahibi olmayanlar iÃ§in devre dÄ±ÅŸÄ± bÄ±rak
            if (video) {
                if (isHost) {
                    video.controls = true;
                    video.muted = false; // Ev sahibi sesi duyabilir
                    if (guestOverlay) guestOverlay.style.display = 'none';
                } else {
                    video.controls = false;
                    video.muted = true; // Misafirler iÃ§in muted (otomatik oynatma iÃ§in)
                    // Overlay'i sadece video durduÄŸunda gÃ¶ster
                    if (guestOverlay) {
                        if (video.paused) {
                            guestOverlay.style.display = 'flex';
                        } else {
                            guestOverlay.style.display = 'none';
                        }
                        const unmuteBtn = document.getElementById('unmuteBtn');
                        if (unmuteBtn) unmuteBtn.style.display = 'block';
                    }
                }
            }
        });

        // Oda dolu
        socket.on('room-full', () => {
            alert('Oda dolu! Maksimum 7 kiÅŸi.');
            window.location.href = '/';
        });

        // Ev sahibi kontrolÃ¼ fonksiyonu
        function checkHostStatus() {
            socket.emit('get-room-users', { roomId });
        }

        // KullanÄ±cÄ± katÄ±ldÄ±
        socket.on('user-joined', (data) => {
            // Ev sahibi kontrolÃ¼ - HER KULLANICI Ä°Ã‡Ä°N
            const currentUser = data.users.find(u => u.username === username);
            isHost = currentUser ? currentUser.isHost : false;
            
            // Video yÃ¼kleme bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster/gizle
            const videoControls = document.getElementById('videoControls');
            const guestOverlay = document.getElementById('guestControlOverlay');
            
            if (videoControls) {
                if (isHost) {
                    videoControls.classList.remove('hidden');
                    videoControls.style.display = 'flex';
                } else {
                    videoControls.classList.add('hidden');
                    videoControls.style.display = 'none';
                }
            }
            
            // Video kontrollerini ev sahibi olmayanlar iÃ§in devre dÄ±ÅŸÄ± bÄ±rak
            if (video) {
                if (isHost) {
                    video.controls = true;
                    video.muted = false; // Ev sahibi sesi duyabilir
                    if (guestOverlay) guestOverlay.style.display = 'none';
                } else {
                    video.controls = false;
                    video.muted = true; // Misafirler iÃ§in muted (otomatik oynatma iÃ§in)
                    // Overlay'i sadece video durduÄŸunda gÃ¶ster
                    if (guestOverlay) {
                        if (video.paused) {
                            guestOverlay.style.display = 'flex';
                        } else {
                            guestOverlay.style.display = 'none';
                        }
                        const unmuteBtn = document.getElementById('unmuteBtn');
                        if (unmuteBtn) unmuteBtn.style.display = 'block';
                    }
                }
            }
            
            updateUserList(data.users);
            
            // Yeni katÄ±lan kullanÄ±cÄ± iÃ§in video yÃ¼kle ve senkronize et
            if (data.user.username === username) {
                if (data.videoUrl) {
                    document.getElementById('videoUrl').value = data.videoUrl;
                    loadHLSVideo(data.videoUrl);
                    
                    // Senkronize ol (video yÃ¼klendikten sonra)
                    const syncAfterLoad = () => {
                        if (video.readyState >= 2) { // Yeterli veri yÃ¼klendi
                            // Ev sahibinin kaldÄ±ÄŸÄ± yerden devam et
                            video.currentTime = data.currentTime;
                            
                            if (data.isPlaying) {
                                if (!isHost) {
                                    video.muted = true;
                                }
                                video.play().then(() => {
                                    // Video oynatÄ±ldÄ±ÄŸÄ±nda overlay'i gizle
                                    if (!isHost) {
                                        const guestOverlay = document.getElementById('guestControlOverlay');
                                        if (guestOverlay) {
                                            guestOverlay.style.display = 'none';
                                        }
                                    }
                                }).catch(err => {
                                    console.error('Video oynatma hatasÄ±:', err);
                                });
                            } else {
                                // Video durduÄŸunda overlay'i gÃ¶ster
                                if (!isHost) {
                                    const guestOverlay = document.getElementById('guestControlOverlay');
                                    if (guestOverlay) {
                                        guestOverlay.style.display = 'flex';
                                    }
                                }
                            }
                        } else {
                            // Video henÃ¼z yÃ¼klenmediyse bekle
                            video.addEventListener('loadeddata', syncAfterLoad, { once: true });
                        }
                    };
                    
                    setTimeout(syncAfterLoad, 500);
                } else {
                    // Video yoksa mevcut durumu senkronize et
                    if (data.currentTime > 0) {
                        video.currentTime = data.currentTime;
                    }
                }
            }
            
            addSystemMessage(`${data.user.username} odaya katÄ±ldÄ±! ğŸ‰`);
        });

        // KullanÄ±cÄ± ayrÄ±ldÄ±
        socket.on('user-left', (data) => {
            updateUserList(data.users);
            addSystemMessage(`${data.username} ayrÄ±ldÄ± ğŸ‘‹`);
        });

        // Ev sahibi ayrÄ±ldÄ±
        socket.on('host-left', (data) => {
            addSystemMessage('âš ï¸ ' + data.message);
            alert('âš ï¸ Ev sahibi odadan ayrÄ±ldÄ±!\n\nOda kapanÄ±yor...');
        });

        // Oda kapatÄ±ldÄ±
        socket.on('room-closed', () => {
            alert('Oda kapatÄ±ldÄ±. Ana sayfaya yÃ¶nlendiriliyorsunuz...');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        });

        // Video deÄŸiÅŸti
        socket.on('video-changed', (data) => {
            document.getElementById('videoUrl').value = data.videoUrl;
            loadHLSVideo(data.videoUrl);
            
            // Yeni video yÃ¼klendiÄŸinde overlay'i gÃ¶ster (misafirler iÃ§in)
            if (!isHost) {
                const guestOverlay = document.getElementById('guestControlOverlay');
                if (guestOverlay) {
                    guestOverlay.style.display = 'flex';
                }
            }
        });

        // Video senkronizasyonu (optimize edilmiÅŸ)
        socket.on('sync-video', (data) => {
            // Debounce: Ã‡ok sÄ±k senkronizasyon yapma
            if (syncDebounceTimer) {
                clearTimeout(syncDebounceTimer);
            }
            
            syncDebounceTimer = setTimeout(() => {
                if (isSyncing) return; // Zaten senkronize ediliyorsa atla
                
                // Son senkronizasyondan 500ms geÃ§mediyse atla
                const now = Date.now();
                if (now - lastSyncTime < 500) {
                    return;
                }
                
                isSyncing = true;
                lastSyncTime = now;
                const guestOverlay = document.getElementById('guestControlOverlay');
                
                // Sadece 3 saniyeden fazla fark varsa senkronize et (donmayÄ± Ã¶nler)
                const timeDiff = Math.abs(video.currentTime - data.currentTime);
                if (timeDiff > 3 && video.readyState >= 2) { // readyState >= 2: yeterli veri yÃ¼klendi
                    // YumuÅŸak senkronizasyon - ani sÄ±Ã§rama yerine kademeli
                    const targetTime = data.currentTime;
                    const currentTime = video.currentTime;
                    const diff = targetTime - currentTime;
                    
                    // EÄŸer fark Ã§ok bÃ¼yÃ¼kse (10 saniye+), direkt atla
                    if (Math.abs(diff) > 10) {
                        video.currentTime = targetTime;
                    } else {
                        // KÃ¼Ã§Ã¼k farklar iÃ§in yumuÅŸak geÃ§iÅŸ
                        video.currentTime = currentTime + (diff * 0.3);
                    }
                }

                // Play/Pause kontrolÃ¼
                if (data.isPlaying) {
                    if (video.paused) {
                        // Otomatik oynatma iÃ§in Ã¶nce muted yap, sonra oynat
                        if (!isHost) {
                            video.muted = true;
                        }
                        const playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    // Oynatma baÅŸarÄ±lÄ±, overlay'i gizle
                                    if (!isHost && guestOverlay) {
                                        guestOverlay.style.display = 'none';
                                    }
                                })
                                .catch(err => {
                                    console.error('âŒ Video oynatma hatasÄ±:', err);
                                });
                        }
                    } else {
                        // Zaten oynatÄ±lÄ±yorsa overlay'i gizle
                        if (!isHost && guestOverlay) {
                            guestOverlay.style.display = 'none';
                        }
                    }
                } else {
                    if (!video.paused) {
                        video.pause();
                    }
                    // Video durduÄŸunda overlay'i gÃ¶ster (sadece misafirler iÃ§in)
                    if (!isHost && guestOverlay) {
                        guestOverlay.style.display = 'flex';
                    }
                }

                setTimeout(() => { isSyncing = false; }, 200);
            }, 100); // 100ms debounce
        });

        // Chat geÃ§miÅŸi
        socket.on('chat-history', (messages) => {
            messages.forEach(msg => addChatMessage(msg));
        });

        // Yeni mesaj
        socket.on('new-message', (msg) => {
            addChatMessage(msg);
        });

        // Emoji tepkisi
        socket.on('show-reaction', (data) => {
            showReaction(data.emoji);
        });

        // Video yÃ¼kle
        document.getElementById('loadVideo').addEventListener('click', () => {
            if (!isHost) {
                alert('Sadece ev sahibi video yÃ¼kleyebilir!');
                return;
            }
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) {
                alert('Video URL girin!');
                return;
            }
            socket.emit('set-video', { roomId, videoUrl: url });
            loadHLSVideo(url);
        });

        // HLS Video yÃ¼kle
        function loadHLSVideo(url) {
            videoOverlay.style.display = 'none';

            if (hls) {
                hls.destroy();
            }

            if (url.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    
                    // HLS buffering kontrolÃ¼
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log('âœ… HLS manifest yÃ¼klendi');
                    });
                    
                    hls.on(Hls.Events.FRAG_LOADED, () => {
                        // Fragment yÃ¼klendi - buffering devam ediyor
                    });
                    
                    // Buffering baÅŸladÄ±ÄŸÄ±nda senkronizasyonu durdur
                    video.addEventListener('waiting', () => {
                        isSyncing = true; // Buffering sÄ±rasÄ±nda senkronizasyon yapma
                    });
                    
                    // Buffering bittiÄŸinde senkronizasyonu devam ettir
                    video.addEventListener('playing', () => {
                        setTimeout(() => { isSyncing = false; }, 500);
                    });
                    
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('âŒ HLS HatasÄ±:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('ğŸ”„ AÄŸ hatasÄ±, yeniden deneniyor...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('ğŸ”„ Medya hatasÄ±, yeniden deneniyor...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    alert('Video yÃ¼klenemedi! URL\'yi kontrol edin.');
                                    hls.destroy();
                                    break;
                            }
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                }
            } else {
                video.src = url;
            }
        }

        // Video olaylarÄ± (sadece ev sahibi kontrol edebilir) - Debounce ile
        let playPauseDebounce = null;
        
        video.addEventListener('play', () => {
            if (isSyncing || document.hidden) return; // Senkronizasyon veya arka planda event'leri yok say
            
            if (isHost) {
                // Debounce: Ã‡ok sÄ±k event gÃ¶nderme
                if (playPauseDebounce) {
                    clearTimeout(playPauseDebounce);
                }
                playPauseDebounce = setTimeout(() => {
                    socket.emit('play-pause', { 
                        roomId, 
                        isPlaying: true, 
                        currentTime: video.currentTime 
                    });
                }, 300);
            } else {
                // Misafir oynatmaya Ã§alÄ±ÅŸÄ±rsa durdur (senkronizasyon deÄŸilse)
                if (!isSyncing) {
                    video.pause();
                }
            }
        });

        video.addEventListener('pause', () => {
            if (isSyncing) return; // Senkronizasyon sÄ±rasÄ±nda event'leri yok say
            
            if (isHost) {
                // Debounce: Ã‡ok sÄ±k event gÃ¶nderme
                if (playPauseDebounce) {
                    clearTimeout(playPauseDebounce);
                }
                playPauseDebounce = setTimeout(() => {
                    socket.emit('play-pause', { 
                        roomId, 
                        isPlaying: false, 
                        currentTime: video.currentTime 
                    });
                }, 300);
            }
        });

        let seekDebounce = null;
        video.addEventListener('seeked', () => {
            if (isSyncing) return; // Senkronizasyon sÄ±rasÄ±nda event'leri yok say
            
            if (isHost) {
                // Debounce: Ã‡ok sÄ±k seek event'i gÃ¶nderme
                if (seekDebounce) {
                    clearTimeout(seekDebounce);
                }
                seekDebounce = setTimeout(() => {
                    socket.emit('seek', { roomId, currentTime: video.currentTime });
                }, 500);
            } else {
                // Misafir sarmaya Ã§alÄ±ÅŸÄ±rsa geri al
                socket.emit('get-current-time', { roomId });
            }
        });

        // Misafirler iÃ§in mevcut zamanÄ± al
        socket.on('current-time', (data) => {
            if (!isHost && !isSyncing && video.readyState >= 2) {
                const timeDiff = Math.abs(video.currentTime - data.currentTime);
                // Sadece 2 saniyeden fazla fark varsa senkronize et
                if (timeDiff > 2) {
                    video.currentTime = data.currentTime;
                }
            }
        });

        // KullanÄ±cÄ± listesi gÃ¼ncelle
        function updateUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = users.map(u => `
                <li class="${u.username === username ? 'me' : ''}">
                    ${u.isHost ? 'ğŸ‘‘' : (u.username === username ? 'ğŸ‘¤' : 'ğŸ‘¥')} ${u.username}
                    ${u.isHost ? '<span style="color: #00ff87; font-size: 10px;">(Ev Sahibi)</span>' : ''}
                </li>
            `).join('');
            document.getElementById('userCount').textContent = users.length;
        }

        // Chat mesajÄ± ekle
        function addChatMessage(msg) {
            const container = document.getElementById('chatMessages');
            if (!container) {
                console.error('Chat messages container bulunamadÄ±!');
                return;
            }
            
            // Container'Ä± zorla gÃ¶rÃ¼nÃ¼r yap
            container.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                overflow-y: auto !important;
                padding: 15px !important;
                padding-bottom: 100px !important;
                background: #161b22 !important;
                position: relative !important;
                z-index: 1 !important;
                min-height: 200px !important;
                height: auto !important;
            `;
            
            const isMe = msg.username === username;
            const div = document.createElement('div');
            div.className = `chat-message ${isMe ? 'me' : ''}`;
            div.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            div.innerHTML = `
                <span class="chat-user">${msg.username}</span>
                <span class="chat-text">${escapeHtml(msg.message)}</span>
            `;
            container.appendChild(div);
            
            // Scroll'u en alta al
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // Sistem mesajÄ±
        function addSystemMessage(text) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            // Container'Ä± zorla gÃ¶rÃ¼nÃ¼r yap
            container.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                overflow-y: auto !important;
                padding: 15px !important;
                padding-bottom: 100px !important;
                background: #161b22 !important;
                position: relative !important;
                z-index: 1 !important;
                min-height: 200px !important;
                height: auto !important;
            `;
            
            const div = document.createElement('div');
            div.className = 'chat-message system';
            div.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            div.innerHTML = `<span class="chat-text">${text}</span>`;
            container.appendChild(div);
            
            // Scroll'u en alta al
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // Emoji tepkisi gÃ¶ster
        function showReaction(emoji) {
            const container = document.getElementById('reactions');
            const span = document.createElement('span');
            span.className = 'floating-emoji';
            span.textContent = emoji;
            span.style.left = Math.random() * 80 + 10 + '%';
            container.appendChild(span);
            setTimeout(() => span.remove(), 2000);
        }

        // HTML escape
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Mesaj gÃ¶nder
        document.getElementById('sendMessage').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                socket.emit('chat-message', { roomId, message });
                input.value = '';
            }
        }

        // Emoji butonlarÄ±
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                socket.emit('reaction', { roomId, emoji: btn.dataset.emoji });
            });
        });

        // Misafirler iÃ§in ses aÃ§ma butonu
        document.getElementById('unmuteBtn')?.addEventListener('click', () => {
            if (video && !isHost) {
                video.muted = false;
                const unmuteBtn = document.getElementById('unmuteBtn');
                if (unmuteBtn) unmuteBtn.style.display = 'none';
            }
        });

        // Video oynatÄ±ldÄ±ÄŸÄ±nda overlay'i gizle (misafirler iÃ§in)
        video.addEventListener('play', () => {
            if (!isHost && !isSyncing && !document.hidden) {
                const guestOverlay = document.getElementById('guestControlOverlay');
                if (guestOverlay) {
                    guestOverlay.style.display = 'none';
                }
            }
        });

        // Video durduÄŸunda overlay'i gÃ¶ster (misafirler iÃ§in)
        video.addEventListener('pause', () => {
            if (!isHost && !isSyncing && !document.hidden) {
                const guestOverlay = document.getElementById('guestControlOverlay');
                if (guestOverlay) {
                    guestOverlay.style.display = 'flex';
                }
            }
        });

        // ========== SESLÄ° KONUÅMA ==========
        
        // PeerJS baÅŸlat
        function initPeer() {
            return new Promise((resolve, reject) => {
                // Rastgele ID oluÅŸtur (daha gÃ¼venilir)
                const peerId = 'peer_' + socket.id + '_' + Date.now();
                
                peer = new Peer(peerId, {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ]
                    },
                    debug: 2
                });

                peer.on('open', (id) => {
                    console.log('âœ… PeerJS baÄŸlandÄ±, ID:', id);
                    socket.emit('peer-id', { roomId, peerId: id, username });
                    resolve(id);
                });

                peer.on('call', (call) => {
                    console.log('ğŸ“ Gelen Ã§aÄŸrÄ±:', call.peer);
                    if (myStream) {
                        call.answer(myStream);
                        const audio = new Audio();
                        audio.autoplay = true;
                        audio.volume = 1.0;
                        
                        call.on('stream', (remoteStream) => {
                            console.log('ğŸ”Š Ses akÄ±ÅŸÄ± alÄ±ndÄ±:', call.peer);
                            audio.srcObject = remoteStream;
                            audio.play().catch(err => {
                                console.error('âŒ Ses Ã§alma hatasÄ±:', err);
                            });
                        });
                        
                        call.on('close', () => {
                            console.log('ğŸ“´ Ã‡aÄŸrÄ± kapandÄ±:', call.peer);
                            audio.pause();
                            audio.srcObject = null;
                        });
                        
                        peers[call.peer] = { call, audio };
                    } else {
                        console.warn('âš ï¸ Mikrofon aÃ§Ä±k deÄŸil, Ã§aÄŸrÄ± reddedildi');
                        call.close();
                    }
                });

                peer.on('error', (err) => {
                    console.error('âŒ PeerJS hatasÄ±:', err);
                    // Alternatif sunucu dene
                    if (err.type === 'server-error') {
                        console.log('ğŸ”„ Alternatif sunucu deneniyor...');
                        peer.destroy();
                        peer = null;
                        reject(err);
                    }
                });

                peer.on('disconnected', () => {
                    console.warn('âš ï¸ PeerJS baÄŸlantÄ±sÄ± kesildi');
                });

                // Timeout
                setTimeout(() => {
                    if (!peer || !peer.open) {
                        reject(new Error('PeerJS baÄŸlantÄ± zaman aÅŸÄ±mÄ±'));
                    }
                }, 10000);
            });
        }

        // Mikrofon aÃ§/kapat
        document.getElementById('toggleMic').addEventListener('click', async () => {
            const btn = document.getElementById('toggleMic');
            btn.disabled = true;
            
            if (!isMicOn) {
                try {
                    console.log('ğŸ¤ Mikrofon aÃ§Ä±lÄ±yor...');
                    
                    // Ã–nce mikrofonu aÃ§
                    myStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        },
                        video: false 
                    });
                    
                    console.log('âœ… Mikrofon aÃ§Ä±ldÄ±');
                    
                    // Sonra peer'i baÅŸlat
                    if (!peer) {
                        try {
                            await initPeer();
                            console.log('âœ… PeerJS baÅŸlatÄ±ldÄ±');
                        } catch (peerErr) {
                            console.error('âŒ PeerJS hatasÄ±:', peerErr);
                            alert('Ses baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyip tekrar deneyin.');
                            myStream.getTracks().forEach(track => track.stop());
                            myStream = null;
                            btn.disabled = false;
                            return;
                        }
                    }
                    
                    isMicOn = true;
                    document.querySelector('.mic-icon').textContent = 'ğŸ”‡';
                    document.querySelector('.mic-text').textContent = 'Mikrofon Kapat';
                    document.getElementById('voiceStatus').innerHTML = 
                        '<span class="status-dot active"></span><span class="status-text">Ses AÃ§Ä±k</span>';
                    
                    // Mevcut kullanÄ±cÄ±lara baÄŸlan
                    setTimeout(() => {
                        socket.emit('get-peer-ids', { roomId });
                    }, 1000);
                    
                } catch (err) {
                    console.error('âŒ Mikrofon hatasÄ±:', err);
                    alert('Mikrofon eriÅŸimi reddedildi! TarayÄ±cÄ± ayarlarÄ±ndan izin verin.');
                    if (myStream) {
                        myStream.getTracks().forEach(track => track.stop());
                        myStream = null;
                    }
                }
            } else {
                console.log('ğŸ”‡ Mikrofon kapatÄ±lÄ±yor...');
                
                // Mikrofonu kapat
                if (myStream) {
                    myStream.getTracks().forEach(track => track.stop());
                    myStream = null;
                }
                
                // TÃ¼m baÄŸlantÄ±larÄ± kapat
                Object.values(peers).forEach(({ call, audio }) => {
                    call.close();
                    if (audio) {
                        audio.pause();
                        audio.srcObject = null;
                    }
                });
                peers = {};
                
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                
                isMicOn = false;
                document.querySelector('.mic-icon').textContent = 'ğŸ¤';
                document.querySelector('.mic-text').textContent = 'Mikrofon AÃ§';
                document.getElementById('voiceStatus').innerHTML = 
                    '<span class="status-dot"></span><span class="status-text">Ses KapalÄ±</span>';
            }
            
            btn.disabled = false;
        });

        // DiÄŸer kullanÄ±cÄ±larÄ±n peer ID'lerini al
        socket.on('peer-ids', (data) => {
            if (!data.peerIds || !Array.isArray(data.peerIds)) {
                console.warn('âš ï¸ Peer ID listesi boÅŸ');
                return;
            }
            
            console.log('ğŸ“‹ Peer ID listesi alÄ±ndÄ±:', data.peerIds.length, 'kullanÄ±cÄ±');
            
            data.peerIds.forEach(({ peerId, username: otherUsername }) => {
                if (peerId && peerId !== peer?.id && myStream && peer && !peers[peerId]) {
                    console.log('ğŸ“ Ã‡aÄŸrÄ± yapÄ±lÄ±yor:', peerId, '->', otherUsername);
                    
                    try {
                        const call = peer.call(peerId, myStream);
                        const audio = new Audio();
                        audio.autoplay = true;
                        audio.volume = 1.0;
                        
                        call.on('stream', (remoteStream) => {
                            console.log('ğŸ”Š Ses akÄ±ÅŸÄ± alÄ±ndÄ±:', otherUsername);
                            audio.srcObject = remoteStream;
                            audio.play().catch(err => {
                                console.error('âŒ Ses Ã§alma hatasÄ±:', err);
                            });
                        });
                        
                        call.on('close', () => {
                            console.log('ğŸ“´ Ã‡aÄŸrÄ± kapandÄ±:', otherUsername);
                            if (audio) {
                                audio.pause();
                                audio.srcObject = null;
                            }
                            delete peers[peerId];
                        });
                        
                        call.on('error', (err) => {
                            console.error('âŒ Ã‡aÄŸrÄ± hatasÄ±:', err);
                        });
                        
                        peers[peerId] = { call, audio };
                    } catch (err) {
                        console.error('âŒ Ã‡aÄŸrÄ± oluÅŸturma hatasÄ±:', err);
                    }
                }
            });
        });

        // Yeni kullanÄ±cÄ± peer ID'si geldiÄŸinde
        socket.on('user-peer-id', (data) => {
            if (data.peerId && data.peerId !== peer?.id && myStream && peer && !peers[data.peerId]) {
                console.log('ğŸ“ Yeni kullanÄ±cÄ±ya Ã§aÄŸrÄ± yapÄ±lÄ±yor:', data.peerId, '->', data.username);
                
                try {
                    const call = peer.call(data.peerId, myStream);
                    const audio = new Audio();
                    audio.autoplay = true;
                    audio.volume = 1.0;
                    
                    call.on('stream', (remoteStream) => {
                        console.log('ğŸ”Š Ses akÄ±ÅŸÄ± alÄ±ndÄ±:', data.username);
                        audio.srcObject = remoteStream;
                        audio.play().catch(err => {
                            console.error('âŒ Ses Ã§alma hatasÄ±:', err);
                        });
                    });
                    
                    call.on('close', () => {
                        console.log('ğŸ“´ Ã‡aÄŸrÄ± kapandÄ±:', data.username);
                        if (audio) {
                            audio.pause();
                            audio.srcObject = null;
                        }
                        delete peers[data.peerId];
                    });
                    
                    call.on('error', (err) => {
                        console.error('âŒ Ã‡aÄŸrÄ± hatasÄ±:', err);
                    });
                    
                    peers[data.peerId] = { call, audio };
                } catch (err) {
                    console.error('âŒ Ã‡aÄŸrÄ± oluÅŸturma hatasÄ±:', err);
                }
            }
        });

        // KullanÄ±cÄ± ayrÄ±ldÄ±ÄŸÄ±nda baÄŸlantÄ±yÄ± kapat
        socket.on('user-left', (data) => {
            // Peer baÄŸlantÄ±larÄ±nÄ± temizle (peer ID eÅŸleÅŸtirmesi yapÄ±labilir)
        });

        // ========== SAYFA GÃ–RÃœNÃœRLÃœK API ==========
        // Arka plana geÃ§ince video durdur, geri gelince devam ettir
        let wasPlayingBeforeHidden = false;

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Sayfa arka plana gitti
                wasPlayingBeforeHidden = !video.paused;
                if (!video.paused && !isHost) {
                    video.pause();
                }
            } else {
                // Sayfa tekrar gÃ¶rÃ¼nÃ¼r oldu
                if (wasPlayingBeforeHidden && !isHost) {
                    // Ev sahibinin durumunu kontrol et
                    socket.emit('get-video-state', { roomId });
                }
            }
        });

        // Video durumunu al (arka plandan dÃ¶ndÃ¼ÄŸÃ¼nde)
        socket.on('video-state', (data) => {
            if (!isHost && !document.hidden) {
                // Mevcut zamanÄ± senkronize et
                const timeDiff = Math.abs(video.currentTime - data.currentTime);
                if (timeDiff > 1) {
                    video.currentTime = data.currentTime;
                }

                // EÄŸer ev sahibi oynatÄ±yorsa, otomatik oynat
                if (data.isPlaying && video.paused) {
                    if (!isHost) {
                        video.muted = true;
                    }
                    video.play().then(() => {
                        if (!isHost) {
                            const guestOverlay = document.getElementById('guestControlOverlay');
                            if (guestOverlay) {
                                guestOverlay.style.display = 'none';
                            }
                        }
                    }).catch(err => {
                        console.error('Video oynatma hatasÄ±:', err);
                    });
                }
            }
        });
    </script>
</body>
</html>

